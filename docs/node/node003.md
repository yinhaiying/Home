<section id="nice" data-tool="mdnice编辑器" data-website="https://www.mdnice.com" style="font-size: 16px; color: black; padding: 0 10px; line-height: 1.6; word-spacing: 0px; letter-spacing: 0px; word-break: break-word; word-wrap: break-word; text-align: left; font-family: Optima-Regular, Optima, PingFangSC-light, PingFangTC-light, 'PingFang SC', Cambria, Cochin, Georgia, Times, 'Times New Roman', serif; margin-top: -10px;"><h1 data-tool="mdnice编辑器" style="margin-top: 70px; margin-bottom: 15px; padding: 0px; font-weight: bold; color: black; font-size: 24px;"><span class="prefix" style="display: none;"></span><span class="content">express核心之中间件</span><span class="suffix"></span></h1>
<h2 data-tool="mdnice编辑器" style="margin-top: 30px; margin-bottom: 15px; padding: 0px; font-weight: bold; color: black; border-bottom: 2px solid rgb(239, 112, 96); font-size: 1.3em;"><span class="prefix" style="display: none;"></span><span class="content" style="display: inline-block; font-weight: bold; background: rgb(239, 112, 96); color: #ffffff; padding: 3px 10px 1px; border-top-right-radius: 3px; border-top-left-radius: 3px; margin-right: 3px;">前言</span><span class="suffix"></span><span style="display: inline-block; vertical-align: bottom; border-bottom: 36px solid #efebe9; border-right: 20px solid transparent;"> </span></h2>
<p data-tool="mdnice编辑器" style="font-size: 16px; padding-top: 8px; padding-bottom: 8px; margin: 0; line-height: 26px; color: black;">Express的官方描述是：一个基于Node.js平台的快速，开放，极简的web框架。这句话中有两个关键词：</p>
<ol data-tool="mdnice编辑器" style="margin-top: 8px; margin-bottom: 8px; padding-left: 25px; color: black; list-style-type: decimal;">
<li><section style="margin-top: 5px; margin-bottom: 5px; line-height: 26px; text-align: left; color: rgb(1,1,1); font-weight: 500;">基于Node。说明Express的初衷就是为了拓展Node的功能，从而提高开发效率。</section></li><li><section style="margin-top: 5px; margin-bottom: 5px; line-height: 26px; text-align: left; color: rgb(1,1,1); font-weight: 500;">web框架。说明Express主要是为了更加方便处理HTTP请求和响应。</section></li></ol>
<p data-tool="mdnice编辑器" style="font-size: 16px; padding-top: 8px; padding-bottom: 8px; margin: 0; line-height: 26px; color: black;">总而言之，Express其实就是在Node内置的HTTP模块上构建了一层抽象，理论上所有Express能够实现的功能，
都可以通过Node来实现。相比于Node，Express具有的优势：</p>
<ul data-tool="mdnice编辑器" style="margin-top: 8px; margin-bottom: 8px; padding-left: 25px; color: black; list-style-type: disc;">
<li><section style="margin-top: 5px; margin-bottom: 5px; line-height: 26px; text-align: left; color: rgb(1,1,1); font-weight: 500;">更加方便地处理HTTP请求与响应（对 request 和 response 对象方法进行了拓展。）</section></li><li><section style="margin-top: 5px; margin-bottom: 5px; line-height: 26px; text-align: left; color: rgb(1,1,1); font-weight: 500;">更加方便地连接数据库</section></li><li><section style="margin-top: 5px; margin-bottom: 5px; line-height: 26px; text-align: left; color: rgb(1,1,1); font-weight: 500;">更加方便的路由（路由语法糖）</section></li><li><section style="margin-top: 5px; margin-bottom: 5px; line-height: 26px; text-align: left; color: rgb(1,1,1); font-weight: 500;">更加方便地渲染模板（允许动态渲染和改变 HTML 内容，并且使用其他语言编写 HTML）</section></li></ul>
<h2 data-tool="mdnice编辑器" style="margin-top: 30px; margin-bottom: 15px; padding: 0px; font-weight: bold; color: black; border-bottom: 2px solid rgb(239, 112, 96); font-size: 1.3em;"><span class="prefix" style="display: none;"></span><span class="content" style="display: inline-block; font-weight: bold; background: rgb(239, 112, 96); color: #ffffff; padding: 3px 10px 1px; border-top-right-radius: 3px; border-top-left-radius: 3px; margin-right: 3px;">中间件</span><span class="suffix"></span><span style="display: inline-block; vertical-align: bottom; border-bottom: 36px solid #efebe9; border-right: 20px solid transparent;"> </span></h2>
<p data-tool="mdnice编辑器" style="font-size: 16px; padding-top: 8px; padding-bottom: 8px; margin: 0; line-height: 26px; color: black;">中间件（Middleware） 是一个函数，它可以访问请求对象（request）, 响应对象（response）, 和 web 应用中处于请求-响应循环流程中的 next的变量。接下来我们先编写一个简单的express应用，看看究竟中间件是什么？</p>
<pre class="custom" data-tool="mdnice编辑器" style="margin-top: 10px; margin-bottom: 10px;"><code class="hljs" style="overflow-x: auto; padding: 16px; color: #383a42; background: #fafafa; display: -webkit-box; font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; border-radius: 0px; font-size: 12px; -webkit-overflow-scrolling: touch;"><span class="hljs-keyword" style="color: #a626a4; line-height: 26px;">const</span>&nbsp;express&nbsp;=&nbsp;<span class="hljs-built_in" style="color: #c18401; line-height: 26px;">require</span>(<span class="hljs-string" style="color: #50a14f; line-height: 26px;">'express'</span>);<br><span class="hljs-keyword" style="color: #a626a4; line-height: 26px;">const</span>&nbsp;app&nbsp;=&nbsp;express();<br><br><span class="hljs-keyword" style="color: #a626a4; line-height: 26px;">const</span>&nbsp;fn&nbsp;=&nbsp;<span class="hljs-function" style="line-height: 26px;">(<span class="hljs-params" style="line-height: 26px;">req,&nbsp;res,&nbsp;next</span>)&nbsp;=&gt;</span>&nbsp;{<br>&nbsp;&nbsp;<span class="hljs-built_in" style="color: #c18401; line-height: 26px;">console</span>.log(<span class="hljs-string" style="color: #50a14f; line-height: 26px;">"hello,world"</span>);<br>};<br>app.use(fn)<br><span class="hljs-keyword" style="color: #a626a4; line-height: 26px;">const</span>&nbsp;port&nbsp;=&nbsp;<span class="hljs-number" style="color: #986801; line-height: 26px;">3000</span>;<br>app.listen(port,()&nbsp;=&gt;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-built_in" style="color: #c18401; line-height: 26px;">console</span>.log(<span class="hljs-string" style="color: #50a14f; line-height: 26px;">`应用运行在<span class="hljs-subst" style="color: #e45649; line-height: 26px;">${port}</span>端口`</span>);<br>})<br></code></pre>
<p data-tool="mdnice编辑器" style="font-size: 16px; padding-top: 8px; padding-bottom: 8px; margin: 0; line-height: 26px; color: black;">当我们访问localhost:3000时就会发现，打印出了函数fn中的hello,world。这里的函数fn就是一个中间件，app.use(fn)就是运行这个中间件，实现他的功能。事实上，整个Express的功能就是由中间件组成，中间件具有的功能包括：</p>
<ol data-tool="mdnice编辑器" style="margin-top: 8px; margin-bottom: 8px; padding-left: 25px; color: black; list-style-type: decimal;">
<li><section style="margin-top: 5px; margin-bottom: 5px; line-height: 26px; text-align: left; color: rgb(1,1,1); font-weight: 500;">执行任何代码。如果没有主动中止，会一直执行所有的中间件。</section></li><li><section style="margin-top: 5px; margin-bottom: 5px; line-height: 26px; text-align: left; color: rgb(1,1,1); font-weight: 500;">调用堆栈中的下一个中间件。如果没有终结请求-响应循环，则必须调用 next() 方法将控制权交给下一个中间件。否则当前程序会被挂起</section></li><li><section style="margin-top: 5px; margin-bottom: 5px; line-height: 26px; text-align: left; color: rgb(1,1,1); font-weight: 500;">终结请求-响应循环。终结请求-响应循环后，之后的中间件不再执行。</section></li></ol>
<p data-tool="mdnice编辑器" style="font-size: 16px; padding-top: 8px; padding-bottom: 8px; margin: 0; line-height: 26px; color: black;">我们通过代码看一下中间件的这些功能：</p>
<pre class="custom" data-tool="mdnice编辑器" style="margin-top: 10px; margin-bottom: 10px;"><code class="hljs" style="overflow-x: auto; padding: 16px; color: #383a42; background: #fafafa; display: -webkit-box; font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; border-radius: 0px; font-size: 12px; -webkit-overflow-scrolling: touch;"><span class="hljs-keyword" style="color: #a626a4; line-height: 26px;">const</span>&nbsp;express&nbsp;=&nbsp;<span class="hljs-built_in" style="color: #c18401; line-height: 26px;">require</span>(<span class="hljs-string" style="color: #50a14f; line-height: 26px;">'express'</span>);<br><span class="hljs-keyword" style="color: #a626a4; line-height: 26px;">const</span>&nbsp;app&nbsp;=&nbsp;express();<br><span class="hljs-comment" style="color: #a0a1a7; font-style: italic; line-height: 26px;">//&nbsp;第一个中间件</span><br>app.use(<span class="hljs-function" style="line-height: 26px;">(<span class="hljs-params" style="line-height: 26px;">req,&nbsp;res,&nbsp;next</span>)&nbsp;=&gt;</span>&nbsp;{<br>&nbsp;&nbsp;<span class="hljs-built_in" style="color: #c18401; line-height: 26px;">console</span>.log(<span class="hljs-string" style="color: #50a14f; line-height: 26px;">"中间件1"</span>);<br>&nbsp;&nbsp;next();<span class="hljs-comment" style="color: #a0a1a7; font-style: italic; line-height: 26px;">//&nbsp;如果没有next则会被挂起</span><br>})<br><span class="hljs-comment" style="color: #a0a1a7; font-style: italic; line-height: 26px;">//&nbsp;第二个中间件</span><br>app.use(<span class="hljs-function" style="line-height: 26px;">(<span class="hljs-params" style="line-height: 26px;">req,&nbsp;res,&nbsp;next</span>)&nbsp;=&gt;</span>&nbsp;{<br>&nbsp;&nbsp;<span class="hljs-built_in" style="color: #c18401; line-height: 26px;">console</span>.log(<span class="hljs-string" style="color: #50a14f; line-height: 26px;">"中间件2"</span>);&nbsp;&nbsp;&nbsp;<span class="hljs-comment" style="color: #a0a1a7; font-style: italic; line-height: 26px;">//继续执行第二个中间件</span><br>&nbsp;&nbsp;next();<br>})<br><span class="hljs-comment" style="color: #a0a1a7; font-style: italic; line-height: 26px;">//&nbsp;第三个中间件</span><br>app.use(<span class="hljs-function" style="line-height: 26px;">(<span class="hljs-params" style="line-height: 26px;">req,&nbsp;res,&nbsp;next</span>)&nbsp;=&gt;</span>&nbsp;{<br>&nbsp;&nbsp;<span class="hljs-built_in" style="color: #c18401; line-height: 26px;">console</span>.log(<span class="hljs-string" style="color: #50a14f; line-height: 26px;">"中间件3"</span>);<br>&nbsp;&nbsp;res.send(<span class="hljs-string" style="color: #50a14f; line-height: 26px;">'hello'</span>);&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment" style="color: #a0a1a7; font-style: italic; line-height: 26px;">//&nbsp;终结请求-响应循环</span><br>})<br><span class="hljs-comment" style="color: #a0a1a7; font-style: italic; line-height: 26px;">//&nbsp;第四个中间件</span><br>app.use(<span class="hljs-function" style="line-height: 26px;">(<span class="hljs-params" style="line-height: 26px;">req,&nbsp;res,&nbsp;next</span>)&nbsp;=&gt;</span>&nbsp;{<br>&nbsp;&nbsp;<span class="hljs-built_in" style="color: #c18401; line-height: 26px;">console</span>.log(<span class="hljs-string" style="color: #50a14f; line-height: 26px;">"中间件4"</span>);&nbsp;&nbsp;&nbsp;<span class="hljs-comment" style="color: #a0a1a7; font-style: italic; line-height: 26px;">//&nbsp;中介后的中间件不再执行</span><br>});<br><span class="hljs-keyword" style="color: #a626a4; line-height: 26px;">const</span>&nbsp;port&nbsp;=&nbsp;<span class="hljs-number" style="color: #986801; line-height: 26px;">3000</span>;<br>app.listen(port,()&nbsp;=&gt;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-built_in" style="color: #c18401; line-height: 26px;">console</span>.log(<span class="hljs-string" style="color: #50a14f; line-height: 26px;">`应用运行在<span class="hljs-subst" style="color: #e45649; line-height: 26px;">${port}</span>端口`</span>);<br>})<br></code></pre>
<p data-tool="mdnice编辑器" style="font-size: 16px; padding-top: 8px; padding-bottom: 8px; margin: 0; line-height: 26px; color: black;">最终的输出结果为：<code style="font-size: 14px; word-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0 2px; background-color: rgba(27,31,35,.05); font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; word-break: break-all; color: rgb(239, 112, 96);">中间件1，中间件2，中间件3</code>。从上面的代码中我们可以知道，如果没有中止请求-响应循环，会执行所有的中间件；如果不是最后一个中止的中间件，必须执行next()。
我们看一下express中间件的模型：
<img src="https://imgkr.cn-bj.ufileos.com/98719956-afcd-4f55-9a8c-31ea3d01a8d7.png" alt style="display: block; margin: 0 auto; max-width: 100%;">
从上面的编程模型，我们可以看出每一个<strong style="font-weight: bold; color: black;">中间件</strong>就是插入到请求开始和响应结束<strong style="font-weight: bold; color: black;">中间</strong>的东西，这也是中间件名字的由来。</p>
<h3 data-tool="mdnice编辑器" style="margin-top: 30px; margin-bottom: 15px; padding: 0px; font-weight: bold; color: black; font-size: 20px;"><span class="prefix" style="display: none;"></span><span class="content">中间件的优点——模块化</span><span class="suffix" style="display: none;"></span></h3>
<p data-tool="mdnice编辑器" style="font-size: 16px; padding-top: 8px; padding-bottom: 8px; margin: 0; line-height: 26px; color: black;">中间件的最大优点就是模块化，每一个中间件是一个独立的函数，实现一个特定的功能，然后通过app.sue将这个函数整合起来。抽离出来就是一个单独的模块。比如，我们要实现一个功能，获取当前请求的url,那么我们就可以将这个功能，封装成一个中间件。</p>
<pre class="custom" data-tool="mdnice编辑器" style="margin-top: 10px; margin-bottom: 10px;"><code class="hljs" style="overflow-x: auto; padding: 16px; color: #383a42; background: #fafafa; display: -webkit-box; font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; border-radius: 0px; font-size: 12px; -webkit-overflow-scrolling: touch;"><span class="hljs-comment" style="color: #a0a1a7; font-style: italic; line-height: 26px;">//实现获取url的模块,封装成中间件</span><br><span class="hljs-keyword" style="color: #a626a4; line-height: 26px;">const</span>&nbsp;fn&nbsp;=&nbsp;<span class="hljs-function" style="line-height: 26px;">(<span class="hljs-params" style="line-height: 26px;">req,&nbsp;res,&nbsp;next</span>)&nbsp;=&gt;</span>&nbsp;{<br>&nbsp;&nbsp;<span class="hljs-keyword" style="color: #a626a4; line-height: 26px;">const</span>&nbsp;url&nbsp;=&nbsp;req.url;<br>&nbsp;&nbsp;<span class="hljs-built_in" style="color: #c18401; line-height: 26px;">console</span>.log(url);<br>&nbsp;&nbsp;next();<br>};<br><br>app.use(fn);<br><br><span class="hljs-keyword" style="color: #a626a4; line-height: 26px;">const</span>&nbsp;port&nbsp;=&nbsp;<span class="hljs-number" style="color: #986801; line-height: 26px;">3000</span>;<br>app.listen(port,()&nbsp;=&gt;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-built_in" style="color: #c18401; line-height: 26px;">console</span>.log(<span class="hljs-string" style="color: #50a14f; line-height: 26px;">`应用运行在<span class="hljs-subst" style="color: #e45649; line-height: 26px;">${port}</span>端口`</span>);<br>})<br></code></pre>
<h2 data-tool="mdnice编辑器" style="margin-top: 30px; margin-bottom: 15px; padding: 0px; font-weight: bold; color: black; border-bottom: 2px solid rgb(239, 112, 96); font-size: 1.3em;"><span class="prefix" style="display: none;"></span><span class="content" style="display: inline-block; font-weight: bold; background: rgb(239, 112, 96); color: #ffffff; padding: 3px 10px 1px; border-top-right-radius: 3px; border-top-left-radius: 3px; margin-right: 3px;">中间件的分类</span><span class="suffix"></span><span style="display: inline-block; vertical-align: bottom; border-bottom: 36px solid #efebe9; border-right: 20px solid transparent;"> </span></h2>
<p data-tool="mdnice编辑器" style="font-size: 16px; padding-top: 8px; padding-bottom: 8px; margin: 0; line-height: 26px; color: black;">Express中的中间件，根据作用范围大致可以分为应用级中间件和路由级中间件。事实上中间件的分类并没有特别明显的区别。</p>
<ul data-tool="mdnice编辑器" style="margin-top: 8px; margin-bottom: 8px; padding-left: 25px; color: black; list-style-type: disc;">
<li><section style="margin-top: 5px; margin-bottom: 5px; line-height: 26px; text-align: left; color: rgb(1,1,1); font-weight: 500;">应用级中间件 app.use()以及它的一些语法糖中使用的中间件</section></li><li><section style="margin-top: 5px; margin-bottom: 5px; line-height: 26px; text-align: left; color: rgb(1,1,1); font-weight: 500;">路由级中间件 router.use(),以及它的一些语法糖中使用的中间件</section></li></ul>
<h3 data-tool="mdnice编辑器" style="margin-top: 30px; margin-bottom: 15px; padding: 0px; font-weight: bold; color: black; font-size: 20px;"><span class="prefix" style="display: none;"></span><span class="content">应用级中间件</span><span class="suffix" style="display: none;"></span></h3>
<p data-tool="mdnice编辑器" style="font-size: 16px; padding-top: 8px; padding-bottom: 8px; margin: 0; line-height: 26px; color: black;">应用级中间件主要是通过app.use()，以及它的一些语法糖中应用的中间件。</p>
<pre class="custom" data-tool="mdnice编辑器" style="margin-top: 10px; margin-bottom: 10px;"><code class="hljs" style="overflow-x: auto; padding: 16px; color: #383a42; background: #fafafa; display: -webkit-box; font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; border-radius: 0px; font-size: 12px; -webkit-overflow-scrolling: touch;"><span class="hljs-keyword" style="color: #a626a4; line-height: 26px;">const</span>&nbsp;express&nbsp;=&nbsp;<span class="hljs-built_in" style="color: #c18401; line-height: 26px;">require</span>(<span class="hljs-string" style="color: #50a14f; line-height: 26px;">'express'</span>);<br><span class="hljs-keyword" style="color: #a626a4; line-height: 26px;">const</span>&nbsp;app&nbsp;=&nbsp;express();<br><span class="hljs-comment" style="color: #a0a1a7; font-style: italic; line-height: 26px;">//&nbsp;&nbsp;应用级中间件</span><br>app.use(<span class="hljs-function" style="line-height: 26px;">(<span class="hljs-params" style="line-height: 26px;">req,&nbsp;res,&nbsp;next</span>)&nbsp;=&gt;</span>&nbsp;{<br>&nbsp;&nbsp;<span class="hljs-keyword" style="color: #a626a4; line-height: 26px;">const</span>&nbsp;url&nbsp;=&nbsp;req.url;<br>&nbsp;&nbsp;next();<br>});<br><br><span class="hljs-comment" style="color: #a0a1a7; font-style: italic; line-height: 26px;">//&nbsp;&nbsp;应用级中间件</span><br>app.get(<span class="hljs-string" style="color: #50a14f; line-height: 26px;">'/user'</span>,(req,res)&nbsp;=&gt;&nbsp;{<br>&nbsp;&nbsp;res.send(<span class="hljs-string" style="color: #50a14f; line-height: 26px;">'应用级中间件'</span>);<br>})<br><span class="hljs-keyword" style="color: #a626a4; line-height: 26px;">const</span>&nbsp;port&nbsp;=&nbsp;<span class="hljs-number" style="color: #986801; line-height: 26px;">3000</span>;<br>app.listen(port,()&nbsp;=&gt;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-built_in" style="color: #c18401; line-height: 26px;">console</span>.log(<span class="hljs-string" style="color: #50a14f; line-height: 26px;">`应用运行在<span class="hljs-subst" style="color: #e45649; line-height: 26px;">${port}</span>端口`</span>);<br>})<br></code></pre>
<p data-tool="mdnice编辑器" style="font-size: 16px; padding-top: 8px; padding-bottom: 8px; margin: 0; line-height: 26px; color: black;">上面的代码中，我们调用了两个中间件，一个是app.use()直接调用的中间件，另外一个是app.use的语法糖app.get()执行的中间件，为什么说app.get()是app.use()的语法糖，因为app.get能够实现的方法使用app.use都能够实现。我们试着将上面app.get的中间件用app.use实现。</p>
<pre class="custom" data-tool="mdnice编辑器" style="margin-top: 10px; margin-bottom: 10px;"><code class="hljs" style="overflow-x: auto; padding: 16px; color: #383a42; background: #fafafa; display: -webkit-box; font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; border-radius: 0px; font-size: 12px; -webkit-overflow-scrolling: touch;">app.use(<span class="hljs-function" style="line-height: 26px;">(<span class="hljs-params" style="line-height: 26px;">req,res,next</span>)&nbsp;=&gt;</span>&nbsp;{<br>&nbsp;&nbsp;<span class="hljs-built_in" style="color: #c18401; line-height: 26px;">console</span>.log(req.path)<br>&nbsp;&nbsp;<span class="hljs-keyword" style="color: #a626a4; line-height: 26px;">if</span>(req.method&nbsp;===&nbsp;<span class="hljs-string" style="color: #50a14f; line-height: 26px;">"GET"</span>&nbsp;&amp;&amp;&nbsp;req.path&nbsp;==&nbsp;<span class="hljs-string" style="color: #50a14f; line-height: 26px;">'/users'</span>){<br>&nbsp;&nbsp;&nbsp;&nbsp;res.send(<span class="hljs-string" style="color: #50a14f; line-height: 26px;">'使用app.use实现的中间件'</span>);<br>&nbsp;&nbsp;}<br>})<br><span class="hljs-comment" style="color: #a0a1a7; font-style: italic; line-height: 26px;">//&nbsp;功能上等价于</span><br>app.get(<span class="hljs-string" style="color: #50a14f; line-height: 26px;">'/user'</span>,(req,res)&nbsp;=&gt;&nbsp;{<br>&nbsp;&nbsp;res.send(<span class="hljs-string" style="color: #50a14f; line-height: 26px;">'应用级中间件'</span>);<br>})<br></code></pre>
<h3 data-tool="mdnice编辑器" style="margin-top: 30px; margin-bottom: 15px; padding: 0px; font-weight: bold; color: black; font-size: 20px;"><span class="prefix" style="display: none;"></span><span class="content">路由级中间件</span><span class="suffix" style="display: none;"></span></h3>
<pre class="custom" data-tool="mdnice编辑器" style="margin-top: 10px; margin-bottom: 10px;"><code class="hljs" style="overflow-x: auto; padding: 16px; color: #383a42; background: #fafafa; display: -webkit-box; font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; border-radius: 0px; font-size: 12px; -webkit-overflow-scrolling: touch;"><span class="hljs-keyword" style="color: #a626a4; line-height: 26px;">const</span>&nbsp;express&nbsp;=&nbsp;<span class="hljs-built_in" style="color: #c18401; line-height: 26px;">require</span>(<span class="hljs-string" style="color: #50a14f; line-height: 26px;">'express'</span>);<br><span class="hljs-keyword" style="color: #a626a4; line-height: 26px;">const</span>&nbsp;app&nbsp;=&nbsp;express();<br><br><span class="hljs-comment" style="color: #a0a1a7; font-style: italic; line-height: 26px;">//&nbsp;定义一个路由</span><br><span class="hljs-keyword" style="color: #a626a4; line-height: 26px;">const</span>&nbsp;user&nbsp;=&nbsp;express.Router();<br>user.use(<span class="hljs-string" style="color: #50a14f; line-height: 26px;">"/"</span>,&nbsp;(req,&nbsp;res)&nbsp;=&gt;&nbsp;{<br>&nbsp;&nbsp;res.send(<span class="hljs-string" style="color: #50a14f; line-height: 26px;">"user.use"</span>);<br>});<br>user.get(<span class="hljs-string" style="color: #50a14f; line-height: 26px;">"/user"</span>,&nbsp;(req,&nbsp;res)&nbsp;=&gt;&nbsp;{<br>&nbsp;&nbsp;res.send(<span class="hljs-string" style="color: #50a14f; line-height: 26px;">"路由级别中间件"</span>);<br>});<br>user.get(<span class="hljs-string" style="color: #50a14f; line-height: 26px;">"/blog"</span>,&nbsp;(req,&nbsp;res)&nbsp;=&gt;&nbsp;{<br>&nbsp;&nbsp;res.send(<span class="hljs-string" style="color: #50a14f; line-height: 26px;">"路由级中间件"</span>);<br>});<br><br><span class="hljs-keyword" style="color: #a626a4; line-height: 26px;">const</span>&nbsp;port&nbsp;=&nbsp;<span class="hljs-number" style="color: #986801; line-height: 26px;">3000</span>;<br>app.listen(port,()&nbsp;=&gt;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-built_in" style="color: #c18401; line-height: 26px;">console</span>.log(<span class="hljs-string" style="color: #50a14f; line-height: 26px;">`应用运行在<span class="hljs-subst" style="color: #e45649; line-height: 26px;">${port}</span>端口`</span>);<br>})<br><br></code></pre>
<p data-tool="mdnice编辑器" style="font-size: 16px; padding-top: 8px; padding-bottom: 8px; margin: 0; line-height: 26px; color: black;">路由级中间件是通过使用express内置的Router生成一个小应用，这个应用跟app具有相同的功能，只不过它主要的功能是用来实现路由。
这种路由功能可以很方便地帮助我们进行路由模块化开发。我们可以将相关的路由弄到同一个模块当中。比如上面的user和blog路由可以抽成
user子路由模块和blog子路由模块。示例如下：</p>
<pre class="custom" data-tool="mdnice编辑器" style="margin-top: 10px; margin-bottom: 10px;"><code class="hljs" style="overflow-x: auto; padding: 16px; color: #383a42; background: #fafafa; display: -webkit-box; font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; border-radius: 0px; font-size: 12px; -webkit-overflow-scrolling: touch;"><span class="hljs-keyword" style="color: #a626a4; line-height: 26px;">const</span>&nbsp;express&nbsp;=&nbsp;<span class="hljs-built_in" style="color: #c18401; line-height: 26px;">require</span>(<span class="hljs-string" style="color: #50a14f; line-height: 26px;">'express'</span>);<br><span class="hljs-keyword" style="color: #a626a4; line-height: 26px;">const</span>&nbsp;app&nbsp;=&nbsp;express();<br><br><span class="hljs-keyword" style="color: #a626a4; line-height: 26px;">const</span>&nbsp;user&nbsp;=&nbsp;<span class="hljs-built_in" style="color: #c18401; line-height: 26px;">require</span>(<span class="hljs-string" style="color: #50a14f; line-height: 26px;">'./routes/user.js'</span>);<br><span class="hljs-keyword" style="color: #a626a4; line-height: 26px;">const</span>&nbsp;blog&nbsp;=&nbsp;<span class="hljs-built_in" style="color: #c18401; line-height: 26px;">require</span>(<span class="hljs-string" style="color: #50a14f; line-height: 26px;">'./routes/blog.js'</span>);<br><span class="hljs-comment" style="color: #a0a1a7; font-style: italic; line-height: 26px;">//&nbsp;抽离子路由</span><br>app.use(<span class="hljs-string" style="color: #50a14f; line-height: 26px;">'/user'</span>,user);<br>app.use(<span class="hljs-string" style="color: #50a14f; line-height: 26px;">'/blog'</span>,blog);<br><span class="hljs-keyword" style="color: #a626a4; line-height: 26px;">const</span>&nbsp;port&nbsp;=&nbsp;<span class="hljs-number" style="color: #986801; line-height: 26px;">3000</span>;<br>app.listen(port,()&nbsp;=&gt;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-built_in" style="color: #c18401; line-height: 26px;">console</span>.log(<span class="hljs-string" style="color: #50a14f; line-height: 26px;">`应用运行在<span class="hljs-subst" style="color: #e45649; line-height: 26px;">${port}</span>端口`</span>);<br>})<br></code></pre>
<p data-tool="mdnice编辑器" style="font-size: 16px; padding-top: 8px; padding-bottom: 8px; margin: 0; line-height: 26px; color: black;">之后只要路径是/user的都会交给user这个子路由去处理。子路由user.js中代码如下：</p>
<pre class="custom" data-tool="mdnice编辑器" style="margin-top: 10px; margin-bottom: 10px;"><code class="hljs" style="overflow-x: auto; padding: 16px; color: #383a42; background: #fafafa; display: -webkit-box; font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; border-radius: 0px; font-size: 12px; -webkit-overflow-scrolling: touch;"><span class="hljs-keyword" style="color: #a626a4; line-height: 26px;">const</span>&nbsp;express&nbsp;=&nbsp;<span class="hljs-built_in" style="color: #c18401; line-height: 26px;">require</span>(<span class="hljs-string" style="color: #50a14f; line-height: 26px;">'express'</span>);<br><br><span class="hljs-keyword" style="color: #a626a4; line-height: 26px;">const</span>&nbsp;router&nbsp;=&nbsp;express.Router();<br>router.get(<span class="hljs-string" style="color: #50a14f; line-height: 26px;">'/'</span>,(req,res)&nbsp;=&gt;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;res.send(<span class="hljs-string" style="color: #50a14f; line-height: 26px;">'这里是user路由'</span>);<br>})<br><span class="hljs-built_in" style="color: #c18401; line-height: 26px;">module</span>.exports&nbsp;=&nbsp;router;<br></code></pre>
<h2 data-tool="mdnice编辑器" style="margin-top: 30px; margin-bottom: 15px; padding: 0px; font-weight: bold; color: black; border-bottom: 2px solid rgb(239, 112, 96); font-size: 1.3em;"><span class="prefix" style="display: none;"></span><span class="content" style="display: inline-block; font-weight: bold; background: rgb(239, 112, 96); color: #ffffff; padding: 3px 10px 1px; border-top-right-radius: 3px; border-top-left-radius: 3px; margin-right: 3px;">开发中间件</span><span class="suffix"></span><span style="display: inline-block; vertical-align: bottom; border-bottom: 36px solid #efebe9; border-right: 20px solid transparent;"> </span></h2>
<p data-tool="mdnice编辑器" style="font-size: 16px; padding-top: 8px; padding-bottom: 8px; margin: 0; line-height: 26px; color: black;">在上面的讲述中，我们知道中间件是一个函数，它是嵌入到一个请求和响应循环中的一个独立的功能块。函数的参数是req,res,next。因此编写一个中间件就显得很简单了。相当于编写一个函数，参数为req,res,next。</p>
<pre class="custom" data-tool="mdnice编辑器" style="margin-top: 10px; margin-bottom: 10px;"><code class="hljs" style="overflow-x: auto; padding: 16px; color: #383a42; background: #fafafa; display: -webkit-box; font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; border-radius: 0px; font-size: 12px; -webkit-overflow-scrolling: touch;"><span class="hljs-comment" style="color: #a0a1a7; font-style: italic; line-height: 26px;">//&nbsp;定义</span><br><span class="hljs-keyword" style="color: #a626a4; line-height: 26px;">const</span>&nbsp;getUrl&nbsp;=&nbsp;<span class="hljs-function" style="line-height: 26px;">(<span class="hljs-params" style="line-height: 26px;">req,res,next</span>)&nbsp;=&gt;</span>&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-built_in" style="color: #c18401; line-height: 26px;">console</span>.log(req.url);<br>&nbsp;&nbsp;&nbsp;&nbsp;next();<br>}<br><span class="hljs-comment" style="color: #a0a1a7; font-style: italic; line-height: 26px;">//&nbsp;使用</span><br>app.use(getUrl)<br></code></pre>
<p data-tool="mdnice编辑器" style="font-size: 16px; padding-top: 8px; padding-bottom: 8px; margin: 0; line-height: 26px; color: black;">从上面的代码我们可以看出，开发一个中间件就是编写一个函数。但是有时候为了能够配置一些参数，我们通常是返回一个函数，比如这样:</p>
<pre class="custom" data-tool="mdnice编辑器" style="margin-top: 10px; margin-bottom: 10px;"><code class="hljs" style="overflow-x: auto; padding: 16px; color: #383a42; background: #fafafa; display: -webkit-box; font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; border-radius: 0px; font-size: 12px; -webkit-overflow-scrolling: touch;"><span class="hljs-keyword" style="color: #a626a4; line-height: 26px;">const</span>&nbsp;getUrl2&nbsp;=&nbsp;<span class="hljs-function" style="line-height: 26px;">(<span class="hljs-params" style="line-height: 26px;">options</span>)&nbsp;=&gt;</span>&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="color: #a626a4; line-height: 26px;">return</span>&nbsp;<span class="hljs-function" style="line-height: 26px;"><span class="hljs-params" style="line-height: 26px;">()</span>&nbsp;=&gt;</span>&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-built_in" style="color: #c18401; line-height: 26px;">console</span>.log(<span class="hljs-string" style="color: #50a14f; line-height: 26px;">`<span class="hljs-subst" style="color: #e45649; line-height: 26px;">${options.pre}</span>+req.url`</span>);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;next();<br>&nbsp;&nbsp;&nbsp;&nbsp;}<br>}<br>app.use(getUrl2({<span class="hljs-attr" style="color: #986801; line-height: 26px;">pre</span>:<span class="hljs-string" style="color: #50a14f; line-height: 26px;">'url:'</span>}))<br></code></pre>
<p data-tool="mdnice编辑器" style="font-size: 16px; padding-top: 8px; padding-bottom: 8px; margin: 0; line-height: 26px; color: black;">这样的话，就需要app.use(getUrl())这样执行了。这就是为什么我们经常看到app.use(bodyParser())这样的使用方法了。实际上返回的还是一个函数，只是为了方便配置参数罢了。</p>
<h2 data-tool="mdnice编辑器" style="margin-top: 30px; margin-bottom: 15px; padding: 0px; font-weight: bold; color: black; border-bottom: 2px solid rgb(239, 112, 96); font-size: 1.3em;"><span class="prefix" style="display: none;"></span><span class="content" style="display: inline-block; font-weight: bold; background: rgb(239, 112, 96); color: #ffffff; padding: 3px 10px 1px; border-top-right-radius: 3px; border-top-left-radius: 3px; margin-right: 3px;">常用中间件</span><span class="suffix"></span><span style="display: inline-block; vertical-align: bottom; border-bottom: 36px solid #efebe9; border-right: 20px solid transparent;"> </span></h2>
<p data-tool="mdnice编辑器" style="font-size: 16px; padding-top: 8px; padding-bottom: 8px; margin: 0; line-height: 26px; color: black;">最后我们例举一些express常用的中间件</p>
<ul data-tool="mdnice编辑器" style="margin-top: 8px; margin-bottom: 8px; padding-left: 25px; color: black; list-style-type: disc;">
<li><section style="margin-top: 5px; margin-bottom: 5px; line-height: 26px; text-align: left; color: rgb(1,1,1); font-weight: 500;">express.static express自带的中间件，用于访问静态文件</section></li><li><section style="margin-top: 5px; margin-bottom: 5px; line-height: 26px; text-align: left; color: rgb(1,1,1); font-weight: 500;">body-parser 第三方中间件，用于解析post数据</section></li><li><section style="margin-top: 5px; margin-bottom: 5px; line-height: 26px; text-align: left; color: rgb(1,1,1); font-weight: 500;">cookie-parser 第三方中间件，用于处理cookie</section></li><li><section style="margin-top: 5px; margin-bottom: 5px; line-height: 26px; text-align: left; color: rgb(1,1,1); font-weight: 500;">cookie-session 第三方中间件，用于处理session</section></li><li><section style="margin-top: 5px; margin-bottom: 5px; line-height: 26px; text-align: left; color: rgb(1,1,1); font-weight: 500;">bcrypt 第三方中间件，用于加密</section></li><li><section style="margin-top: 5px; margin-bottom: 5px; line-height: 26px; text-align: left; color: rgb(1,1,1); font-weight: 500;">passport 第三方中间件，用于鉴权</section></li><li><section style="margin-top: 5px; margin-bottom: 5px; line-height: 26px; text-align: left; color: rgb(1,1,1); font-weight: 500;">passport-jwt 第三方中间件，用于jwt鉴权</section></li></ul>
<h2 data-tool="mdnice编辑器" style="margin-top: 30px; margin-bottom: 15px; padding: 0px; font-weight: bold; color: black; border-bottom: 2px solid rgb(239, 112, 96); font-size: 1.3em;"><span class="prefix" style="display: none;"></span><span class="content" style="display: inline-block; font-weight: bold; background: rgb(239, 112, 96); color: #ffffff; padding: 3px 10px 1px; border-top-right-radius: 3px; border-top-left-radius: 3px; margin-right: 3px;">总结</span><span class="suffix"></span><span style="display: inline-block; vertical-align: bottom; border-bottom: 36px solid #efebe9; border-right: 20px solid transparent;"> </span></h2>
<p data-tool="mdnice编辑器" style="font-size: 16px; padding-top: 8px; padding-bottom: 8px; margin: 0; line-height: 26px; color: black;">到目前为止，我们详细介绍了Express的核心中间件，从中间件的详细理解到中间件的分类和使用，以及中间件的编写，最后列举了一些常见的中间件。通过本文我们基本上就能够掌握Express的核心功能了，其他的Express的API都是中间件的使用罢了。</p>
</section>