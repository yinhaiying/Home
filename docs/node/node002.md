<section id="nice" data-tool="mdnice编辑器" data-website="https://www.mdnice.com" style="font-size: 16px; color: black; padding: 0 10px; line-height: 1.6; word-spacing: 0px; letter-spacing: 0px; word-break: break-word; word-wrap: break-word; text-align: left; font-family: Optima-Regular, Optima, PingFangSC-light, PingFangTC-light, 'PingFang SC', Cambria, Cochin, Georgia, Times, 'Times New Roman', serif; margin-top: -10px;"><h1 data-tool="mdnice编辑器" style="margin-top: 30px; margin-bottom: 15px; padding: 0px; font-weight: bold; color: black; font-size: 24px;"><span class="prefix" style="display: none;"></span><span class="content">socket.io初体验之简易聊天室</span><span class="suffix"></span></h1>
<h2 data-tool="mdnice编辑器" style="margin-top: 30px; margin-bottom: 15px; padding: 0px; font-weight: bold; color: black; border-bottom: 2px solid rgb(239, 112, 96); font-size: 1.3em;"><span class="prefix" style="display: none;"></span><span class="content" style="display: inline-block; font-weight: bold; background: rgb(239, 112, 96); color: #ffffff; padding: 3px 10px 1px; border-top-right-radius: 3px; border-top-left-radius: 3px; margin-right: 3px;">websocket</span><span class="suffix"></span><span style="display: inline-block; vertical-align: bottom; border-bottom: 36px solid #efebe9; border-right: 20px solid transparent;"> </span></h2>
<p data-tool="mdnice编辑器" style="font-size: 16px; padding-top: 8px; padding-bottom: 8px; margin: 0; line-height: 26px; color: black;">随着信息技术的飞速发展，对数据的实时性有着更高的追求，传统的信息通信，通常是客户端通过浏览器发出一个请求，然后服务器端在接收请求处理后并将结果返回给客户端，浏览器再将信息更新展示出来。也就是说只能浏览器主动发起请求，才能获取数据的更新。这种数据的获取方式在一些对数据实时性要求较高的业务中就显得不适用了，比如常见的股票交易等。<br>
在早期，为了能够不断地获取服务器的更新，人们通常采用轮循的方式，浏览器不断地向服务器端发送请求，比如每隔几秒钟就请求一次，这种方式虽然能够近似地获取数据的实时更新，但是加大了服务器的压力。而且，没办法知道服务器数据是否已经更新，只能固定地去请求，如果服务器数据没有更新，那么增加了很多的无效请求。<br>
因此，由于这种方式的局限性，人们希望找到一种新的通信方式，不需要客户端发起请求，服务器端在数据更新时能够主动发送数据到客户端，从而实现数据的实时更新，而且避免了很多无效请求。这就是websocket技术。 Socket.IO是一个基于 Node.js 的实时应用程序框架，在即时通讯、通知与消息推送，实时分析等场景中有较为广泛的应用。在本文中我们会搭建一个简单的聊天室，实现socket.io的常见功能。</p>
<h2 data-tool="mdnice编辑器" style="margin-top: 30px; margin-bottom: 15px; padding: 0px; font-weight: bold; color: black; border-bottom: 2px solid rgb(239, 112, 96); font-size: 1.3em;"><span class="prefix" style="display: none;"></span><span class="content" style="display: inline-block; font-weight: bold; background: rgb(239, 112, 96); color: #ffffff; padding: 3px 10px 1px; border-top-right-radius: 3px; border-top-left-radius: 3px; margin-right: 3px;">socket.io</span><span class="suffix"></span><span style="display: inline-block; vertical-align: bottom; border-bottom: 36px solid #efebe9; border-right: 20px solid transparent;"> </span></h2>
<p data-tool="mdnice编辑器" style="font-size: 16px; padding-top: 8px; padding-bottom: 8px; margin: 0; line-height: 26px; color: black;">socket.io需要在服务器端和客户端同时进行设置，实现双向连接，其主要步骤如下：</p>
<ol data-tool="mdnice编辑器" style="margin-top: 8px; margin-bottom: 8px; padding-left: 25px; color: black; list-style-type: decimal;">
<li><section style="margin-top: 5px; margin-bottom: 5px; line-height: 26px; text-align: left; color: rgb(1,1,1); font-weight: 500;">先从服务器端说起。服务器端先初始化Socket，然后与端口绑定(bind)，对端口进行监听(listen)，调用accept阻塞，等待客户端连接。</section></li><li><section style="margin-top: 5px; margin-bottom: 5px; line-height: 26px; text-align: left; color: rgb(1,1,1); font-weight: 500;">在这时如果有个客户端初始化一个Socket，然后连接服务器(connect)，如果连接成功，这时客户端与服务器端的连接就建立了。</section></li><li><section style="margin-top: 5px; margin-bottom: 5px; line-height: 26px; text-align: left; color: rgb(1,1,1); font-weight: 500;">客户端发送数据请求，服务器端接收请求并处理请求，然后把回应数据发送给客户端，客户端读取数据，最后关闭连接，一次交互结束。
加下来我们就按照上面的顺序搭建一个简易的聊天室。</section></li></ol>
<h2 data-tool="mdnice编辑器" style="margin-top: 30px; margin-bottom: 15px; padding: 0px; font-weight: bold; color: black; border-bottom: 2px solid rgb(239, 112, 96); font-size: 1.3em;"><span class="prefix" style="display: none;"></span><span class="content" style="display: inline-block; font-weight: bold; background: rgb(239, 112, 96); color: #ffffff; padding: 3px 10px 1px; border-top-right-radius: 3px; border-top-left-radius: 3px; margin-right: 3px;">具体实现</span><span class="suffix"></span><span style="display: inline-block; vertical-align: bottom; border-bottom: 36px solid #efebe9; border-right: 20px solid transparent;"> </span></h2>
<ol data-tool="mdnice编辑器" style="margin-top: 8px; margin-bottom: 8px; padding-left: 25px; color: black; list-style-type: decimal;">
<li><section style="margin-top: 5px; margin-bottom: 5px; line-height: 26px; text-align: left; color: rgb(1,1,1); font-weight: 500;">服务器端初始化：</section></li></ol>
<pre class="custom" data-tool="mdnice编辑器" style="margin-top: 10px; margin-bottom: 10px;"><code class="hljs" style="overflow-x: auto; padding: 16px; color: #333; background: #f8f8f8; display: block; font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; border-radius: 0px; font-size: 12px; -webkit-overflow-scrolling: touch;"><span class="hljs-keyword" style="color: #333; font-weight: bold; line-height: 26px;">const</span> socket = <span class="hljs-built_in" style="color: #0086b3; line-height: 26px;">require</span>(<span class="hljs-string" style="color: #d14; line-height: 26px;">'socket.io'</span>);
<span/><span class="hljs-keyword" style="color: #333; font-weight: bold; line-height: 26px;">const</span> server = app.listen(<span class="hljs-string" style="color: #d14; line-height: 26px;">'8000'</span>,() =&gt; {
<span/>    <span class="hljs-built_in" style="color: #0086b3; line-height: 26px;">console</span>.log(<span class="hljs-string" style="color: #d14; line-height: 26px;">'服务器正在8000端口运行'</span>);
<span/>});
<span/><span class="hljs-comment" style="color: #998; font-style: italic; line-height: 26px;">// 设置socket.io</span>
<span/><span class="hljs-keyword" style="color: #333; font-weight: bold; line-height: 26px;">const</span> io = socket(server);  <span class="hljs-comment" style="color: #998; font-style: italic; line-height: 26px;">// 将server服务器传递给socket</span>
<span/>io.on(<span class="hljs-string" style="color: #d14; line-height: 26px;">'connection'</span>,(socket) =&gt; {
<span/>    <span class="hljs-built_in" style="color: #0086b3; line-height: 26px;">console</span>.log(<span class="hljs-string" style="color: #d14; line-height: 26px;">'a user connected'</span>);
<span/>})
<span/></code></pre>
<ol start="2" data-tool="mdnice编辑器" style="margin-top: 8px; margin-bottom: 8px; padding-left: 25px; color: black; list-style-type: decimal;">
<li><section style="margin-top: 5px; margin-bottom: 5px; line-height: 26px; text-align: left; color: rgb(1,1,1); font-weight: 500;">客户端初始化socket：
客户端初始化一个Socket，然后连接服务器(connect)，如果连接成功，这时客户端与服务器端的连接就建立了。</section></li></ol>
<pre class="custom" data-tool="mdnice编辑器" style="margin-top: 10px; margin-bottom: 10px;"><code class="hljs" style="overflow-x: auto; padding: 16px; color: #333; background: #f8f8f8; display: block; font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; border-radius: 0px; font-size: 12px; -webkit-overflow-scrolling: touch;"><span class="hljs-tag" style="color: #000080; font-weight: normal; line-height: 26px;">&lt;<span class="hljs-name" style="color: #000080; font-weight: normal; line-height: 26px;">script</span> <span class="hljs-attr" style="color: #008080; line-height: 26px;">src</span> = <span class="hljs-string" style="color: #d14; line-height: 26px;">"https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.3.0/socket.io.js"</span>&gt;</span><span class="hljs-tag" style="color: #000080; font-weight: normal; line-height: 26px;">&lt;/<span class="hljs-name" style="color: #000080; font-weight: normal; line-height: 26px;">script</span>&gt;</span>
<span/><span class="hljs-tag" style="color: #000080; font-weight: normal; line-height: 26px;">&lt;<span class="hljs-name" style="color: #000080; font-weight: normal; line-height: 26px;">script</span>&gt;</span><span class="javascript" style="line-height: 26px;">
<span/>  <span class="hljs-keyword" style="color: #333; font-weight: bold; line-height: 26px;">var</span> socket = io.connect(<span class="hljs-string" style="color: #d14; line-height: 26px;">'http://localhost:8000'</span>);
<span/></span><span class="hljs-tag" style="color: #000080; font-weight: normal; line-height: 26px;">&lt;/<span class="hljs-name" style="color: #000080; font-weight: normal; line-height: 26px;">script</span>&gt;</span>
<span/></code></pre>
<p data-tool="mdnice编辑器" style="font-size: 16px; padding-top: 8px; padding-bottom: 8px; margin: 0; line-height: 26px; color: black;">客户端引入socket.io.js会暴露一个io对象，通过io对象提供的connect方法连接。客户端和服务器端建立好连接之后，客户端就可以像服务器端发送数据了。</p>
<ol start="3" data-tool="mdnice编辑器" style="margin-top: 8px; margin-bottom: 8px; padding-left: 25px; color: black; list-style-type: decimal;">
<li><section style="margin-top: 5px; margin-bottom: 5px; line-height: 26px; text-align: left; color: rgb(1,1,1); font-weight: 500;">客户端发送数据请求:</section></li></ol>
<pre class="custom" data-tool="mdnice编辑器" style="margin-top: 10px; margin-bottom: 10px;"><code class="hljs" style="overflow-x: auto; padding: 16px; color: #333; background: #f8f8f8; display: block; font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; border-radius: 0px; font-size: 12px; -webkit-overflow-scrolling: touch;">btn.addEventListener(<span class="hljs-string" style="color: #d14; line-height: 26px;">'click'</span>,() =&gt; {
<span/>    <span class="hljs-comment" style="color: #998; font-style: italic; line-height: 26px;">// 实现客户端向服务器发送数据</span>
<span/>    socket.emit(<span class="hljs-string" style="color: #d14; line-height: 26px;">'chat'</span>,{
<span/>        <span class="hljs-attr" style="line-height: 26px;">message</span>:message.value,
<span/>        <span class="hljs-attr" style="line-height: 26px;">handle</span>:handle.value
<span/>    })
<span/>});
<span/></code></pre>
<ol start="4" data-tool="mdnice编辑器" style="margin-top: 8px; margin-bottom: 8px; padding-left: 25px; color: black; list-style-type: decimal;">
<li><section style="margin-top: 5px; margin-bottom: 5px; line-height: 26px; text-align: left; color: rgb(1,1,1); font-weight: 500;">服务器端接收请求并处理请求，然后把回应数据发送给客户端。</section></li></ol>
<pre class="custom" data-tool="mdnice编辑器" style="margin-top: 10px; margin-bottom: 10px;"><code class="hljs" style="overflow-x: auto; padding: 16px; color: #333; background: #f8f8f8; display: block; font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; border-radius: 0px; font-size: 12px; -webkit-overflow-scrolling: touch;">io.on(<span class="hljs-string" style="color: #d14; line-height: 26px;">'connection'</span>,(socket) =&gt; {
<span/>    <span class="hljs-comment" style="color: #998; font-style: italic; line-height: 26px;">// 获取从客户端发送过来的数据</span>
<span/>    socket.on(<span class="hljs-string" style="color: #d14; line-height: 26px;">'chat'</span>,(data) =&gt; {
<span/>      io.sockets.emit(<span class="hljs-string" style="color: #d14; line-height: 26px;">'chat'</span>,data)
<span/>    });
<span/>})
<span/></code></pre>
<ol start="5" data-tool="mdnice编辑器" style="margin-top: 8px; margin-bottom: 8px; padding-left: 25px; color: black; list-style-type: decimal;">
<li><section style="margin-top: 5px; margin-bottom: 5px; line-height: 26px; text-align: left; color: rgb(1,1,1); font-weight: 500;">客户端读取数据</section></li></ol>
<pre class="custom" data-tool="mdnice编辑器" style="margin-top: 10px; margin-bottom: 10px;"><code class="hljs" style="overflow-x: auto; padding: 16px; color: #333; background: #f8f8f8; display: block; font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; border-radius: 0px; font-size: 12px; -webkit-overflow-scrolling: touch;">socket.on(<span class="hljs-string" style="color: #d14; line-height: 26px;">'chat'</span>,(data) =&gt; {
<span/>    feedback.innerHTML = <span class="hljs-string" style="color: #d14; line-height: 26px;">""</span>;
<span/>    output.innerHTML += <span class="hljs-string" style="color: #d14; line-height: 26px;">`&lt;p&gt;&lt;strong&gt;<span class="hljs-subst" style="color: #333; font-weight: normal; line-height: 26px;">${data.handle}</span>:<span class="hljs-subst" style="color: #333; font-weight: normal; line-height: 26px;">${data.message}</span>&lt;/strong&gt;&lt;/p&gt;`</span>
<span/>})
<span/></code></pre>
<p data-tool="mdnice编辑器" style="font-size: 16px; padding-top: 8px; padding-bottom: 8px; margin: 0; line-height: 26px; color: black;">到目前为止，一次完整的交互结束。我们实现的是客户端的数据，服务器端会向所有的客户端(包括自己)进行发送，但是有时候我们不希望向自己发送，比如正在输入中...这种信息只能其他的客户端可见，对自身是不可见的，socket.io提供了广播事件，通过socket.broadcast.emit可以向除自己以外的客户端发送数据。
最终实现的效果如下：
<img src="https://imgkr.cn-bj.ufileos.com/c76df2b1-1358-41f6-8c90-fd87f76c1c7c.gif" alt="简易聊天室" style="display: block; margin: 0 auto; max-width: 100%;"></p>
<p data-tool="mdnice编辑器" style="font-size: 16px; padding-top: 8px; padding-bottom: 8px; margin: 0; line-height: 26px; color: black;">具体的实现可查看<a href="https://github.com/yinhaiying/advanced_node/tree/master/program/chat-app" style="text-decoration: none; word-wrap: break-word; font-weight: bold; color: rgb(239, 112, 96); border-bottom: 1px solid rgb(239, 112, 96);">github</a></p>
</section>